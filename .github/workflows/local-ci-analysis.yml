# 文件路径: .github/workflows/local-ci-analysis.yml
# 描述: 这是一个为本地环境设计的CI工作流。
# 版本 4 (完美版): 修正了AI分析的触发条件，确保在测试步骤失败时能被精确触发。

name: "本地CI与AI分析流水线"

on: [push, workflow_dispatch]

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest
    steps:
      - name: "1. 拉取代码"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "2. 设置Java环境"
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: "3. 设置Gradle缓存"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "4. 运行测试并生成报告"
        id: run_tests
        continue-on-error: true
        env:
          GRADLE_OPTS: "-Dhttps.proxyHost=host.docker.internal -Dhttps.proxyPort=7890 -Dhttp.proxyHost=host.docker.internal -Dhttp.proxyPort=7890"
        run: |
          chmod +x ./gradlew
          ./gradlew test

      - name: "5. 🚀 AI分析失败原因 (仅在测试失败时运行)"
        # 关键修正：将 `if: failure()` 修改为 `if: steps.run_tests.outcome == 'failure'`
        # 这会精确地检查上一步的结果，而不管 continue-on-error 的设置。
        if: steps.run_tests.outcome == 'failure'
        run: |
          chmod +x ./scripts/analyze_failure.sh
          ./scripts/analyze_failure.sh
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: "6. 📊 上报遥测数据到本地OpenSearch (总是运行)"
        if: always()
        run: |
          chmod +x ./scripts/upload_telemetry.sh
          ./scripts/upload_telemetry.sh

