# æ–‡ä»¶è·¯å¾„: .github/workflows/local-ci-analysis.yml
# æè¿°: è¿™æ˜¯ä¸€ä¸ªä¸ºæœ¬åœ°ç¯å¢ƒè®¾è®¡çš„CIå·¥ä½œæµã€‚

name: "æœ¬åœ°CIä¸AIåˆ†ææµæ°´çº¿"

on: [push, workflow_dispatch]

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest
    steps:
      - name: "1. æ‹‰å–ä»£ç "
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "2. è®¾ç½®Javaç¯å¢ƒ"
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: "3. è®¾ç½®Gradleç¼“å­˜"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "4. è¿è¡Œæµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š"
        id: run_tests
        continue-on-error: true
        env:
          GRADLE_OPTS: "-Dhttps.proxyHost=host.docker.internal -Dhttps.proxyPort=7890 -Dhttp.proxyHost=host.docker.internal -Dhttp.proxyPort=7890"
        run: |
          chmod +x ./gradlew
          ./gradlew test

      - name: "5. ğŸš€ AIåˆ†æå¤±è´¥åŸå›  (ä»…åœ¨æµ‹è¯•å¤±è´¥æ—¶è¿è¡Œ)"
        if: steps.run_tests.outcome == 'failure'
        # å…³é”®ä¿®æ­£ï¼šä¸ºæ•´ä¸ªæ­¥éª¤è®¾ç½®ä»£ç†ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿curlå¯ä»¥è®¿é—®å¤–éƒ¨APIã€‚
        env:
          https_proxy: "http://host.docker.internal:7890"
          http_proxy: "http://host.docker.internal:7890"
          no_proxy: "localhost,127.0.0.1"
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          sed -i 's/\r$//' ./scripts/analyze_failure.sh
          chmod +x ./scripts/analyze_failure.sh
          ./scripts/analyze_failure.sh

      - name: "6. ğŸ“Š ä¸ŠæŠ¥é¥æµ‹æ•°æ®åˆ°æœ¬åœ°OpenSearch (æ€»æ˜¯è¿è¡Œ)"
        if: always()
        run: |
          sed -i 's/\r$//' ./scripts/upload_telemetry.sh
          chmod +x ./scripts/upload_telemetry.sh
          ./scripts/upload_telemetry.sh

