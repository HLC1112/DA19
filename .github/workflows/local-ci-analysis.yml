# æ–‡ä»¶è·¯å¾„: .github/workflows/local-ci-analysis.yml
# æè¿°: è¿™æ˜¯ä¸€ä¸ªä¸ºæœ¬åœ°ç¯å¢ƒè®¾è®¡çš„CIå·¥ä½œæµã€‚
# å®ƒä½¿ç”¨ 'act' åœ¨æœ¬åœ°è¿è¡Œï¼Œæ¨¡æ‹Ÿå®Œæ•´çš„CI/CDæµç¨‹ï¼ŒåŒ…æ‹¬åœ¨æµ‹è¯•å¤±è´¥æ—¶è°ƒç”¨AIè¿›è¡Œåˆ†æã€‚

name: "æœ¬åœ°CIä¸AIåˆ†ææµæ°´çº¿"

on: [push, workflow_dispatch] # å®šä¹‰è§¦å‘æ¡ä»¶ï¼Œæœ¬åœ°è¿è¡Œæ—¶å¯å¿½ç•¥

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest # actä¼šä½¿ç”¨ä¸€ä¸ªDockerå®¹å™¨æ¥æ¨¡æ‹Ÿè¿™ä¸ªç¯å¢ƒ
    steps:
      - name: "1. æ‹‰å–ä»£ç "
        uses: actions/checkout@v4
        with:
          # æ‹‰å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥ä¾¿'git diff'å¯ä»¥æ­£å¸¸å·¥ä½œ
          fetch-depth: 0

      - name: "2. è®¾ç½®Javaç¯å¢ƒ"
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: "3. è®¾ç½®Gradleç¼“å­˜"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "4. è¿è¡Œæµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š"
        id: run_tests
        # å…³é”®: 'continue-on-error: true' ç¡®ä¿å³ä½¿æµ‹è¯•å¤±è´¥ï¼Œå·¥ä½œæµä¹Ÿä¼šç»§ç»­æ‰§è¡Œåç»­çš„åˆ†ææ­¥éª¤
        continue-on-error: true
        run: ./gradlew test

      - name: "5. ğŸš€ AIåˆ†æå¤±è´¥åŸå›  (ä»…åœ¨æµ‹è¯•å¤±è´¥æ—¶è¿è¡Œ)"
        # å…³é”®: 'if: failure()' æ¡ä»¶åˆ¤æ–­ï¼Œåªæœ‰ä¸Šä¸€æ­¥ï¼ˆæˆ–ä¹‹å‰ä»»ä½•ä¸€æ­¥ï¼‰å¤±è´¥æ—¶æ‰æ‰§è¡Œ
        if: failure()
        run: |
          chmod +x ./scripts/analyze_failure.sh
          ./scripts/analyze_failure.sh
        env:
          # å…³é”®: å°†ä»actå‘½ä»¤ä¼ å…¥çš„secretè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›è„šæœ¬ä½¿ç”¨
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: "6. ğŸ“Š ä¸ŠæŠ¥é¥æµ‹æ•°æ®åˆ°æœ¬åœ°OpenSearch (æ€»æ˜¯è¿è¡Œ)"
        # å…³é”®: 'if: always()' ç¡®ä¿æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œæµ‹è¯•æ•°æ®éƒ½ä¼šè¢«ä¸ŠæŠ¥
        if: always()
        run: |
          chmod +x ./scripts/upload_telemetry.sh
          ./scripts/upload_telemetry.sh

